<!-- Index.HTML -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacation Selection Form</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">

    <?!= include('Styles'); ?>
    <base target="_top">
</head>

<body class="bg-gray-100 font-sans antialiased flex items-center justify-center min-h-screen py-12">

    <!-- <div style="background-color: #fffbe6; border: 1px solid #ffe58f; padding: 10px; font-family: monospace; display:none;" id="debug-panel">
        <strong>DEBUG PANEL:</strong><br>
        The email Google sees for you is: <strong>
            <?!= debugEmail ?>
        </strong>
    </div> -->

    <script>
        // This 'rosterData' variable is injected by Code.gs (in doGet)
        const allEmployees = <?!= rosterData ?>;
    </script>


    <div id="loading-screen">
        <h2>Loading Your Information...</h2>
        <p>Please wait.</p>
    </div>

    <div id="form-content" style="display:none;">
      <div class="bg-white p-8 rounded-lg shadow-md max-w-xl w-full">
        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 24px; background-color: #f8fafc;">
          
          <div style="display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 12px;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin: 0;">
              Welcome, <span id="emp-name"></span>
            </h3>
            <span id="emp-rank" style="font-size: 0.9rem; font-weight: 500; color: #475569; background-color: #e2e8f0; padding: 4px 8px; border-radius: 6px;"></span>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 0.9rem;">
            
            <div>
              <span style="display: block; font-size: 0.8rem; color: #64748b; text-transform: uppercase;">Employee ID</span>
              <strong id="emp-id" style="color: #334155;"></strong>
            </div>
            
            <div>
              <span style="display: block; font-size: 0.8rem; color: #64748b; text-transform: uppercase;">Hire Date</span>
              <strong id="emp-hire-date" style="color: #334155;"></strong>
            </div>

            <div>
              <span style="display: block; font-size: 0.8rem; color: #64748b; text-transform: uppercase;">Years of Service</span>
              <strong id="emp-years" style="color: #334155;"></strong>
            </div>
            
            <div>
              <span style="display: block; font-size: 0.8rem; color: #64748b; text-transform: uppercase;">Vacation Hours</span>
              <strong id="emp-vac-hours" style="color: #334155;"></strong>
            </div>

            <div>
              <span style="display: block; font-size: 0.8rem; color: #64748b; text-transform: uppercase;">Holiday Hours</span>
              <strong id="emp-hol-hours" style="color: #334155;"></strong>
            </div>

            <div>
              <span style="display: block; font-size: 0.8rem; color: #64748b; text-transform: uppercase;">Shift</span>
              <strong id="emp-shift" style="color: #334155;"></strong>
            </div>

          </div>
        </div>

          <?!= include('Form_Refactored'); ?>
      </div>
    </div>


    <div id="manual-login" style="display:none;">
        <h2>Could not find your user profile.</h2>
        <p>Please enter your Employee ID or Name to search:</p>

        <input type="text" id="manual-search-text" style="width: 100%;">

        <div id="search-results" style="margin-top: 15px;">
        </div>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Form Submission Data</h3>
            <div class="bg-gray-50 p-4 rounded-md">
                <pre id="modal-content" class="text-sm text-gray-800"></pre>
            </div>
            <div class="mt-6 text-right">
                <button id="close-modal" type="button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <script>
        // This runs as soon as the page is loaded
        window.addEventListener("load", function () {
            google.script.run
                .withSuccessHandler(onInitialDataLoaded)
                .withFailureHandler(onLoadError)
                .getInitialUserInfo();
        });

        //
        // --- THIS IS THE CRITICAL FUNCTION ---
        //
        function onInitialDataLoaded(data) {

            console.log(data)
            // // 1. Check for logs and print them to the debug panel
            // if (data && data.hasOwnProperty('logs')) {
            //     var debugPanel = document.getElementById("debug-panel");
            //     var logContent = data.logs.join('<br>');
            //     debugPanel.innerHTML += "<br>--- Auto-Login Log ---<br>" + logContent;
            //     debugPanel.style.display = "block";
            // }
            

            // 2. The original logic to check for success (this still works perfectly)
            if (data && data.hasOwnProperty('userInfo') && data.userInfo) {
                // SUCCESS!
                window.USER_INFO = data.userInfo;
                initializeDatepicker();
                initializeFormLogic();

                fillUserInfo(data.userInfo);
                if (data.hasOwnProperty('previousPicks') && data.previousPicks) {
                    fillPreviousPicks(data.previousPicks);
                }
                document.getElementById("loading-screen").style.display = "none";
                document.getElementById("form-content").style.display = "block";

            } else {
                // FAILURE!
                document.getElementById("loading-screen").style.display = "none";
                document.getElementById("manual-login").style.display = "block";
            }
        }

        function onLoadError(err) {
            // Hard script failure
            document.getElementById("loading-screen").style.display = "none";
            document.getElementById("manual-login").style.display = "block";
            // document.getElementById("debug-panel").style.display = "block";
            alert("A script error occurred: " + err.message);
        }


        // --- ALL THE OTHER FUNCTIONS ARE CORRECT ---

        document.getElementById("manual-search-text").addEventListener("input", function () {
            var searchLower = String(this.value).toLowerCase().trim();
            var localMatches = [];

            if (searchLower.length > 0) {
                for (var i = 0; i < allEmployees.length; i++) {
                    var emp = allEmployees[i];
                    var searchCorpus = emp.id + " " + emp.name + " " + emp.searchString + " " + emp.tokensCsv;
                    if (searchCorpus.toLowerCase().includes(searchLower)) {
                        localMatches.push(emp);
                    }
                }
            }
            onMatchesFound(localMatches);
        });

        function onMatchesFound(matches) {
            var resultsDiv = document.getElementById("search-results");
            if (!matches || matches.length === 0) {
                resultsDiv.innerHTML = "<p style='color:red;'>No matches found.</p>";
                return;
            }
            var maxResults = 10;
            var truncated = matches.length > maxResults;
            var displayMatches = matches.slice(0, maxResults);
            var listHtml = "<p>" + matches.length + " people found. Please select your name:</p>";
            listHtml += "<ul style='list-style: none; padding-left: 0;'>";
            displayMatches.forEach(function (user) {
                listHtml += "<li style='margin-bottom: 5px;'>" +
                    "<a href='#' class='user-select' data-id='" + user.id + "' style='text-decoration: none; padding: 5px 10px; border: 1px solid #ccc; display: inline-block; border-radius: 4px;'>" +
                    user.name + " (ID: " + user.id + ")" +
                    "</a>" +
                    "</li>";
            });
            if (truncated) {
                listHtml += "<li>...and " + (matches.length - maxResults) + " more.</li>";
            }
            listHtml += "</ul>";
            resultsDiv.innerHTML = listHtml;
        }

        document.getElementById("search-results").addEventListener("click", function (event) {
            var clickedLink = event.target.closest('a.user-select');
            if (clickedLink) {
                event.preventDefault();
                var selectedId = clickedLink.getAttribute("data-id");
                document.getElementById("search-results").innerHTML = "<p>Loading data for ID " + selectedId + "...</p>";
                loadFullData(selectedId);
            }
        });

        function loadFullData(employeeId) {
            google.script.run
                .withSuccessHandler(onManualDataLoaded)
                .withFailureHandler(onLoadError)
                .getEmployeeDataAndPicks(employeeId);
        }

        function onManualDataLoaded(data) {
            if (data && data.hasOwnProperty('userInfo') && data.userInfo) {
                fillUserInfo(data.userInfo);
                if (data.hasOwnProperty('previousPicks') && data.previousPicks) {
                    fillPreviousPicks(data.previousPicks);
                }
                document.getElementById("manual-login").style.display = "none";
                document.getElementById("form-content").style.display = "block";
            } else {
                document.getElementById("search-results").innerHTML = "<p style='color:red;'>Error loading data for that ID. Please try again.</p>";
            }
        }

        function fillUserInfo(userInfo) {
            document.getElementById("emp-name").innerText = userInfo.employeeName;
            document.getElementById("emp-id").innerText = userInfo.employeeId;
            document.getElementById("emp-rank").innerText = userInfo.rank;
            document.getElementById("emp-hire-date").innerText = userInfo.hireDate;
            document.getElementById("emp-years").innerText = userInfo.yearsOfService;
            document.getElementById("emp-vac-hours").innerText = userInfo.vacationHours;
            document.getElementById("emp-hol-hours").innerText = userInfo.holidayHours;
            document.getElementById("emp-shift").innerText = userInfo.shift;
        }

        /**
         * Enforces the shift checkbox state (disabled/enabled) based on the date input's value.
         */
        function enforceCheckboxState($input, dayNum) {
            const dateText = $input.val();
            const $shiftCheckboxes = $(`input[name="day${dayNum}Shift"]`);
            const $feedback = $(`#day${dayNum}-shift-feedback`);
            
            if (!dateText) {
                $shiftCheckboxes.prop('disabled', false).prop('checked', true);
                $feedback.text('').removeClass('bg-red-200 bg-blue-200 bg-orange-200 text-red-800 text-blue-800 text-orange-800 border-red-400 border-blue-400 border-orange-400 border');
                return;
            }

            const userAssignedShift = window.USER_INFO ? window.USER_INFO.shift : null;

            try {
                const dateParts = dateText.split('/');
                const dateForCalc = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                const { shift: selectedShift } = getShiftAndBlock(dateForCalc);

                if (selectedShift !== userAssignedShift) {
                    $shiftCheckboxes.prop('disabled', true).prop('checked', false);
                } else {
                    $shiftCheckboxes.prop('disabled', false).prop('checked', true);
                }
            } catch (e) {
                console.error("Error during checkbox enforcement:", e);
                $shiftCheckboxes.prop('disabled', true).prop('checked', false);
            }
        }

        /**
         * Fills data into a specific date block and ensures the global state is updated.
         * This is called by fillPreviousPicks.
         * @param {string} dateText - The RAW date string (e.g., "Fri Feb 06 2026...").
         * @param {string} shiftsString - Comma-separated shifts (e.g., "Day1, Day2").
         * @param {number} dayIndex - The day number (1, 2, 3...)
         */
        function loadPickIntoDayBlock(dateText, shiftsString, dayIndex) {
            const $dateInput = $(`#day${dayIndex}-date`);
            
            // --- FIX A: PARSE AND FORMAT THE DATE ---
            let blockStartDate;
            let formattedDate;
            try {
                // 1. Create a Date object from the raw string
                blockStartDate = new Date(dateText);
                
                // 2. Format it to MM/DD/YYYY
                // We'll add a simple formatter here to be safe
                let month = (blockStartDate.getMonth() + 1).toString().padStart(2, '0');
                let day = blockStartDate.getDate().toString().padStart(2, '0');
                let year = blockStartDate.getFullYear();
                formattedDate = `${month}/${day}/${year}`;

            } catch (e) {
                console.error(`Could not parse date ${dateText} for day ${dayIndex}.`, e);
                $dateInput.val("INVALID DATE"); // Show an error
                return; // Stop
            }
            // ------------------------------------

            // 1. Set the *formatted* date value in the input field
            $dateInput.val(formattedDate);

            // 2. Set the global selection state (using the Date object)
            allSelectedBlockStarts[dayIndex] = blockStartDate;
            
            // 3. Set checkboxes (This will run now that the date parsing is fixed)
            const shiftsArray = shiftsString.split(',').map(s => s.trim());
            
            $(`input[name="day${dayIndex}Shift"]`).prop('checked', false);
            shiftsArray.forEach(shiftValue => {
                $(`input[name="day${dayIndex}Shift"][value="${shiftValue}"]`).prop('checked', true);
            });

            // 4. Force enforcement/feedback update
            enforceCheckboxState($dateInput, dayIndex);
        }

        function fillPreviousPicks(picksRow) {
        // picksRow is the full array: [SubmissionDate, FirstName, ..., Day 1, Shift 1, Day 2, Shift 2, ...]
        
        // --- FIX B: SET ACKNOWLEDGMENT ---
        // Acknowledgment is at index 7 (the 8th column)
        var acknowledgment = picksRow[7]; 
        if (acknowledgment) {
            // 1. Check the radio button
            $(`input[name="formCompletion"][value="${acknowledgment}"]`).prop('checked', true);
            
            // 2. Manually trigger 'change' so the form shows the day selection container
            $('input[name="formCompletion"]').trigger('change');
        }
        // ----------------------------------
        
        var START_PICK_INDEX = 9; // Index of Day 1 column (Column J)
        var pickCount = 0;

        // We iterate through the picksRow, jumping 2 columns at a time.
        for (var i = START_PICK_INDEX; i < picksRow.length; i += 2) {
            var dateText = picksRow[i]; // This is the RAW date string
            var shiftString = picksRow[i + 1]; // e.g., "Day1, Day2"
            
            // Stop if the date column is empty
            if (!dateText) break;

            pickCount++;
            
            // A. Handle Day 1 (which is already in the DOM)
            if (pickCount === 1) {
                loadPickIntoDayBlock(dateText, shiftString, 1);
            } else {
                // B. Handle Day 2 and subsequent days
                addNewDayBlock(); // This function should be global from DatepickerInit.html
                loadPickIntoDayBlock(dateText, shiftString, currentDayCount);
            }
        }
    
    // CRITICAL: Refresh all datepickers to show the correct global highlights
    $('.datepicker').datepicker('refresh'); 
}
    </script>
</body>

</html>