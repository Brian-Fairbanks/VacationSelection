<script>
    // Global variables initialized in DatepickerInit
    let currentDayCount = 1;
    const MAX_DAYS = 30;
    defaultStartDate = new Date('2026-02-04')
    endSelectDate = new Date('2027-01-01')
    // Global list to track all selected block start dates
    let allSelectedBlockStarts = {};

    /**
     * Generates the HTML string for a new day selection block.
     * NOTE: We remove the 'disabled' check from the template since it's now handled 
     * dynamically in onSelect whenever a date is picked.
     */
    function createDayBlock(dayNum) {
        return `
        <div id="day-${dayNum}-selection" class="flex flex-col sm:flex-row gap-4 sm:gap-8 items-start sm:items-end py-4 border-t mt-4" style="display: none;">
                
                <div class="flex-1 min-w-0">
                        <label for="day${dayNum}-date" class="block text-base font-medium text-gray-700 mb-1">Date</label>
                        <div class="flex items-center space-x-2">
                                <input type="text" id="day${dayNum}-date" name="day${dayNum}Date" class="datepicker w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="MM/DD/YYYY">
                                <span id="day${dayNum}-shift-feedback" class="text-xs px-2 py-1 rounded-full font-semibold border border-transparent transition-all duration-300 whitespace-nowrap"></span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">MM-DD-YYYY (Click input for calendar)</p>
                </div>

                <div class="shrink-0">
                        <label class="block text-base font-medium text-gray-700 mb-1">Shift Selection ${dayNum}</label>
                        <div class="flex space-x-4">
                                <div class="flex items-center">
                                        <input id="day${dayNum}-shift-day1" name="day${dayNum}Shift" type="checkbox" value="Day1" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="day${dayNum}-shift-day1" class="ml-2 text-sm font-medium text-gray-700">Day 1</label>
                                </div>
                                <div class="flex items-center">
                                        <input id="day${dayNum}-shift-day2" name="day${dayNum}Shift" type="checkbox" value="Day2" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="day${dayNum}-shift-day2" class="ml-2 text-sm font-medium text-gray-700">Day 2</label>
                                </div>
                        </div>
                </div>
        </div>
        `;
    }

    /**
     * This function contains your complex datepicker configuration.
     */
    var selectedDate=undefined
    function applyComplexDatepicker(inputElement) {

        $(inputElement).datepicker({
            dateFormat: 'mm/dd/yy',
            defaultDate: defaultStartDate,

            // Your hover logic (unchanged)
            beforeShow: function (input, inst) { // Use the 'input' argument
                console.log("Clicked on an instance!");
                // You can log the jQuery-wrapped version
                console.log($(input));
                window.selectedDate = this.value
                console.log(window.selectedDate)

                

                setTimeout(function () {
                    $('.ui-datepicker-calendar a').off('mouseenter mouseleave')
                        .on('mouseenter', function () {
                            const tdElement = $(this).closest('td');
                            const dayNum = parseInt($(this).text(), 10);
                            const linkMonth = parseInt(tdElement.attr('data-month'), 10);
                            const linkYear = parseInt(tdElement.attr('data-year'), 10);
                            if (isNaN(dayNum) || isNaN(linkMonth) || isNaN(linkYear)) return;
                            const linkDate = new Date(linkYear, linkMonth, dayNum);
                            const { blockStartDate } = getShiftAndBlock(linkDate);
                            toggleBlockHover(blockStartDate, 'add');
                        })
                        .on('mouseleave', function () {
                            const tdElement = $(this).closest('td');
                            const dayNum = parseInt($(this).text(), 10);
                            const linkMonth = parseInt(tdElement.attr('data-month'), 10);
                            const linkYear = parseInt(tdElement.attr('data-year'), 10);
                            if (isNaN(dayNum) || isNaN(linkMonth) || isNaN(linkYear)) return;
                            const linkDate = new Date(linkYear, linkMonth, dayNum);
                            const { blockStartDate } = getShiftAndBlock(linkDate);
                            toggleBlockHover(blockStartDate, 'remove');
                        });
                }, 0);
            },

            // --- onSelect (Modified for Checkbox Disabling) ---
            onSelect: function (dateText, inst) {
                const selectedDate = new Date(inst.selectedYear, inst.selectedMonth, inst.selectedDay);
                const { blockStartDate, shift } = getShiftAndBlock(selectedDate);
                const $input = $(this);
                const dayNum = parseInt(this.id.match(/^day(\d+)-date$/)[1]);
                const userAssignedShift = window.USER_INFO ? window.USER_INFO.shift : null;
                console.log(`selectedDate:${selectedDate}, dayNum:${dayNum}, input:${$input} `);
                if (blockStartDate) {
                    allSelectedBlockStarts[dayNum] = blockStartDate;

                    const formattedDate = formatDate(blockStartDate);
                    $input.val(formattedDate);

                    // Refresh ALL datepickers to show the new global state
                    $('.datepicker').datepicker('refresh');

                    // Update the feedback span for *this* input
                    const $feedback = $(`#day${dayNum}-shift-feedback`);
                     const { block } = getShiftAndBlock(blockStartDate);

                    //  none of this should actually be needed, limitations are handled in beforeShowDay

                    // // --- DYNAMIC CHECKBOX ENFORCEMENT ---
                    // const $shiftCheckboxes = $(`input[name="day${dayNum}Shift"]`);

                    // if (shift !== userAssignedShift) {
                    //     // If selected shift doesn't match user's shift, disable and uncheck
                    //     $shiftCheckboxes.prop('disabled', true).prop('checked', false);
                    // } else {
                    //     // If it matches, ensure they are enabled and checked by default
                    //     $shiftCheckboxes.prop('disabled', false).prop('checked', true);
                    // }
                    // // ------------------------------------

                }

                // Add new day logic (unchanged)
                if (dayNum === currentDayCount && currentDayCount < MAX_DAYS) {
                    addNewDayBlock();
                }
            },

            // --- beforeShowDay (Modified for Calendar Day Disabling) ---
            beforeShowDay: function (date) {
              const { class: shiftClass, blockStartDate, shift: currentShift } = getShiftAndBlock(date);
              let extraClass = shiftClass;
              
              const userAssignedShift = window.USER_INFO ? window.USER_INFO.shift : null;
              let isSelectable = true;
              let isGloballyBooked = false;



              // --- SAFETY CHECK (Prevents 'reading properties of null' during refresh) ---
              const currentInst = $.datepicker._curInst;
              if (!currentInst || !currentInst.input) {
                  // This can happen on a refresh. Check if user's shift is loaded yet.
                  if (userAssignedShift && currentShift && currentShift !== userAssignedShift) {
                      return [false, shiftClass, `Shift ${currentShift}`];
                  }
                  return [true, shiftClass, `Shift ${currentShift}`];
              }
              const currentInput = currentInst.input; 
              const currentDayNumMatch = currentInput.attr('id').match(/^day(\d+)-date$/);
              const currentDayNum = currentDayNumMatch ? parseInt(currentDayNumMatch[1]) : null;
              // -----------------------------------------------------------

              // 1. SHIFT RESTRICTION CHECK: Disable days that don't match the user's shift
              if (userAssignedShift && currentShift && currentShift !== userAssignedShift) {
                  isSelectable = false;
              }


              // 2. GLOBAL BOOKING CHECK & HIGHLIGHT LOGIC
              const currentDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

              for (const dayKey in allSelectedBlockStarts) {
                  const selectedBlockStartDate = allSelectedBlockStarts[dayKey];
                  if (!selectedBlockStartDate) continue; 
                  
                  // --- KEY MODIFICATION: Skip checking the dates selected by the current input ---
                  if (parseInt(dayKey) === currentDayNum) {
                      continue;
                  }

                  // Calculate the two days of the globally selected block
                  const selectedDay1 = new Date(selectedBlockStartDate.getFullYear(), selectedBlockStartDate.getMonth(), selectedBlockStartDate.getDate());
                  const selectedDay2 = new Date(selectedDay1);
                  selectedDay2.setDate(selectedDay2.getDate() + 1);

                  // Check if the current calendar day matches any OTHER selected block
                  const isDay1Match = currentDate.getTime() === selectedDay1.getTime();
                  const isDay2Match = currentDate.getTime() === selectedDay2.getTime();

                  if (isDay1Match || isDay2Match) {
                      isGloballyBooked = true;
                      extraClass += ' ui-state-highlight ui-state-active selected-shift-day globally-booked-disabled'; 
                      break;
                  }
              }
              
              // 3. ENFORCEMENT: If the day is part of an already selected block (by a *different* input), make it UNSELECTABLE
              if (isGloballyBooked) {
                  isSelectable = false;
              }


              // 4. BLOCK STYLING (Unchanged)
              if (blockStartDate) {
                  const secondDay = new Date(blockStartDate.getFullYear(), blockStartDate.getMonth(), blockStartDate.getDate());
                  secondDay.setDate(secondDay.getDate() + 1);
                  const isBlockStart = currentDate.getTime() === blockStartDate.getTime();
                  const isBlockSecondDay = currentDate.getTime() === secondDay.getTime();
                  const firstDayIsWeekend = blockStartDate.getDay() === 0 || blockStartDate.getDay() === 6;
                  const secondDayIsWeekend = secondDay.getDay() === 0 || secondDay.getDay() === 6;
                  const bothDaysWeekend = firstDayIsWeekend && secondDayIsWeekend;

                  if (isBlockStart) { extraClass += ' shift-block-start'; if (bothDaysWeekend) extraClass += ' both-days-weekend'; }
                  if (isBlockSecondDay) { extraClass += ' shift-block-end'; if (bothDaysWeekend) extraClass += ' both-days-weekend'; }
              }
              
              // 5. CURRENT INPUT'S SELECTION (Your logic, fixed)
              // 'date' is the calendar day. 'currentSelectionDate' is the specific day from the calendar
              const currentSelectionDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
              
              // Get the date string from your global variable
              const myGlobalDateString = window.selectedDate;

              if (myGlobalDateString) { // Check if it's not ""
                  try {
                      // Create a Date object from the global string (e.g., "02/12/2026")
                      const dateParts = myGlobalDateString.split('/');
                      const mySelectedBlock = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);

                      // Calculate the two days of the block
                      const selectedDay1 = new Date(mySelectedBlock.getFullYear(), mySelectedBlock.getMonth(), mySelectedBlock.getDate());
                      const selectedDay2 = new Date(selectedDay1);
                      selectedDay2.setDate(selectedDay2.getDate() + 1);

                      // --- THIS IS THE FIX ---
                      // Compare the CALENDAR DAY (currentDate) to the GLOBAL block
                      const isDay1Match = currentDate.getTime() === selectedDay1.getTime();
                      const isDay2Match = currentDate.getTime() === selectedDay2.getTime();

                      if (isDay1Match || isDay2Match) {
                          // It's a match, so highlight and "unlock" it
                          extraClass += ' ui-state-highlight ui-state-active selected-shift-day';
                          extraClass = extraClass.replace('globally-booked-disabled', '');
                          isSelectable = true; // Override any previous 'false'
                      }
                  } catch (e) {
                      // This will catch "Invalid Date" errors if the string is bad
                  }
              }
              
              // Return [isSelectable, extraClass, title]
              return [isSelectable, extraClass, `Shift ${currentShift}`];
            }
        });

        // Handle clearing an input
        $(inputElement).on('change', function () {
            if ($(this).val() === "") {
                const dayNum = parseInt(this.id.match(/^day(\d+)-date$/)[1]);
                delete allSelectedBlockStarts[dayNum];
                $('.datepicker').datepicker('refresh');
                window.selectedDate = undefined;

                // Re-enable checkboxes and clear feedback if the date is manually erased
                const $shiftCheckboxes = $(`input[name="day${dayNum}Shift"]`);
                $shiftCheckboxes.prop('disabled', false).prop('checked', true); // Revert to default checked/enabled
                $(`#day${dayNum}-shift-feedback`).text('').removeClass('bg-red-200 bg-blue-200 bg-orange-200 text-red-800 text-blue-800 text-orange-800 border-red-400 border-blue-400 border-orange-400 border');
            }
        });
    }

    /**
     * Handles creating the new block, initializing its datepicker, and showing it.
     */
    function addNewDayBlock() {
        currentDayCount++;
        const newBlockHtml = createDayBlock(currentDayCount);
        const $newBlock = $(newBlockHtml);
        $('#day-selection-container').append($newBlock);

        // Apply the complex datepicker to the new input
        const newInput = $newBlock.find('.datepicker');
        applyComplexDatepicker(newInput);

        $newBlock.slideDown(200);
    }

    /**
     * This is the main function called from Form_Refactored.html
     */
    function initializeDatepicker() {
        applyComplexDatepicker('#day1-date');
    }
</script>