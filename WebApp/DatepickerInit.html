<script>
    // Counter to track the days
    let currentDayCount = 1;
    const MAX_DAYS = 30;

    // **THE NEW GLOBAL LIST**
    // We will store all selections here, by day number.
    // Example: { 1: DateObject, 2: DateObject, ... }
    let allSelectedBlockStarts = {};

    /**
     * Generates the HTML string for a new day selection block.
     */
    function createDayBlock(dayNum) {
        // (This function is unchanged)
        return `
        <div id="day-${dayNum}-selection" class="flex flex-col sm:flex-row gap-4 sm:gap-8 items-start sm:items-end py-4 border-t mt-4" style="display: none;">
                <div class="flex-1 min-w-0">
                        <label for="day${dayNum}-date" class="block text-base font-medium text-gray-700 mb-1">Date</label>
                        <div class="flex items-center space-x-2">
                                <input type="text" id="day${dayNum}-date" name="day${dayNum}Date" class="datepicker w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="MM/DD/YYYY">
                                <span id="day${dayNum}-shift-feedback" class="text-xs px-2 py-1 rounded-full font-semibold border border-transparent transition-all duration-300 whitespace-nowrap"></span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">MM-DD-YYYY (Click input for calendar)</p>
                </div>
                <div class="shrink-0">
                        <label class="block text-base font-medium text-gray-700 mb-1">Shift Selection ${dayNum}</label>
                        <div class="flex space-x-4">
                                <div class="flex items-center">
                                        <input id="day${dayNum}-shift-day1" name="day${dayNum}Shift" type="checkbox" value="Day1" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="day${dayNum}-shift-day1" class="ml-2 text-sm font-medium text-gray-700">Day 1</label>
                                </div>
                                <div class="flex items-center">
                                        <input id="day${dayNum}-shift-day2" name="day${dayNum}Shift" type="checkbox" value="Day2" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="day${dayNum}-shift-day2" class="ml-2 text-sm font-medium text-gray-700">Day 2</label>
                                </div>
                        </div>
                </div>
        </div>
        `;
    }

    /**
     * This function contains your complex datepicker configuration.
     */
    function applyComplexDatepicker(inputElement) {

        $(inputElement).datepicker({
            dateFormat: 'mm/dd/yy',
            defaultDate: new Date('2026-02-04'),

            // Your hover logic (unchanged)
            beforeShow: function () {
                setTimeout(function () {
                    $('.ui-datepicker-calendar a').off('mouseenter mouseleave')
                        .on('mouseenter', function () {
                            const tdElement = $(this).closest('td');
                            const dayNum = parseInt($(this).text(), 10);
                            const linkMonth = parseInt(tdElement.attr('data-month'), 10);
                            const linkYear = parseInt(tdElement.attr('data-year'), 10);
                            if (isNaN(dayNum) || isNaN(linkMonth) || isNaN(linkYear)) return;
                            const linkDate = new Date(linkYear, linkMonth, dayNum);
                            const { blockStartDate } = getShiftAndBlock(linkDate);
                            toggleBlockHover(blockStartDate, 'add');
                        })
                        .on('mouseleave', function () {
                            const tdElement = $(this).closest('td');
                            const dayNum = parseInt($(this).text(), 10);
                            const linkMonth = parseInt(tdElement.attr('data-month'), 10);
                            const linkYear = parseInt(tdElement.attr('data-year'), 10);
                            if (isNaN(dayNum) || isNaN(linkMonth) || isNaN(linkYear)) return;
                            const linkDate = new Date(linkYear, linkMonth, dayNum);
                            const { blockStartDate } = getShiftAndBlock(linkDate);
                            toggleBlockHover(blockStartDate, 'remove');
                        });
                }, 0);
            },

            // --- onSelect (Modified) ---
            onSelect: function (dateText, inst) {
                const selectedDate = new Date(inst.selectedYear, inst.selectedMonth, inst.selectedDay);
                const { blockStartDate } = getShiftAndBlock(selectedDate);
                const $input = $(this);
                const dayNum = parseInt(this.id.match(/^day(\d+)-date$/)[1]);

                if (blockStartDate) {
                    // **CHANGE:** Instead of storing on $(this).data,
                    // we now store it in the global list, indexed by our day number.
                    allSelectedBlockStarts[dayNum] = blockStartDate;

                    const formattedDate = formatDate(blockStartDate);
                    $input.val(formattedDate);

                    // Refresh ALL datepickers to show the new global state
                    $('.datepicker').datepicker('refresh');

                    // Update the feedback span for *this* input (unchanged)
                    const $feedback = $(`#day${dayNum}-shift-feedback`);
                    const { shift, block } = getShiftAndBlock(blockStartDate);
                    $feedback.text(`${shift} Shift (Block ${block})`).attr('class', 'text-xs px-2 py-1 rounded-full font-semibold border border-transparent transition-all duration-300 whitespace-nowrap');
                    if (shift === 'A') $feedback.addClass('bg-red-200 text-red-800 border-red-400');
                    else if (shift === 'B') $feedback.addClass('bg-blue-200 text-blue-800 border-blue-400');
                    else $feedback.addClass('bg-orange-200 text-orange-800 border-orange-400');
                }

                // Add new day logic (unchanged)
                if (dayNum === currentDayCount && currentDayCount < MAX_DAYS) {
                    addNewDayBlock();
                }
            },

            // --- beforeShowDay (Modified) ---
            beforeShowDay: function (date) {
                const { class: shiftClass, blockStartDate } = getShiftAndBlock(date);
                let extraClass = shiftClass;

                // Your block-styling logic (unchanged)
                if (blockStartDate) {
                    const currentDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                    const secondDay = new Date(blockStartDate.getFullYear(), blockStartDate.getMonth(), blockStartDate.getDate());
                    secondDay.setDate(secondDay.getDate() + 1);
                    const isBlockStart = currentDate.getTime() === blockStartDate.getTime();
                    const isBlockSecondDay = currentDate.getTime() === secondDay.getTime();
                    const firstDayIsWeekend = blockStartDate.getDay() === 0 || blockStartDate.getDay() === 6;
                    const secondDayIsWeekend = secondDay.getDay() === 0 || secondDay.getDay() === 6;
                    const bothDaysWeekend = firstDayIsWeekend && secondDayIsWeekend;
                    if (isBlockStart) { extraClass += ' shift-block-start'; if (bothDaysWeekend) extraClass += ' both-days-weekend'; }
                    if (isBlockSecondDay) { extraClass += ' shift-block-end'; if (bothDaysWeekend) extraClass += ' both-days-weekend'; }
                }

                // **CHANGE:** We no longer look at $(this).data.
                // Instead, we loop through our NEW global list.
                let isSelected = false;
                for (const dayKey in allSelectedBlockStarts) {
                    const selectedBlockStartDate = allSelectedBlockStarts[dayKey];
                    if (!selectedBlockStartDate) continue; // Skip if this entry is null

                    const currentDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                    const secondDay = new Date(selectedBlockStartDate.getFullYear(), selectedBlockStartDate.getMonth(), selectedBlockStartDate.getDate());
                    secondDay.setDate(secondDay.getDate() + 1);

                    const isBlockStart = currentDate.getTime() === selectedBlockStartDate.getTime();
                    const isBlockSecondDay = currentDate.getTime() === secondDay.getTime();

                    if (isBlockStart || isBlockSecondDay) {
                        isSelected = true;
                        break; // Found a match, no need to check others
                    }
                }

                if (isSelected) {
                    extraClass += ' ui-state-highlight ui-state-active selected-shift-day';
                }

                return [true, extraClass, `Shift ${shiftClass.replace('shift-', '')}`];
            }
        });

        // **BONUS FEATURE:** Handle clearing an input
        // If a user blanks out a date, remove it from the global list
        $(inputElement).on('change', function () {
            if ($(this).val() === "") {
                const dayNum = parseInt(this.id.match(/^day(\d+)-date$/)[1]);
                // Remove from the global list
                delete allSelectedBlockStarts[dayNum];
                // Refresh all datepickers
                $('.datepicker').datepicker('refresh');
            }
        });
    }

    /**
     * Handles creating the new block, initializing its datepicker, and showing it.
     */
    function addNewDayBlock() {
        currentDayCount++;
        const newBlockHtml = createDayBlock(currentDayCount);
        const $newBlock = $(newBlockHtml);
        $('#day-selection-container').append($newBlock);

        // Apply the complex datepicker to the new input
        const newInput = $newBlock.find('.datepicker');
        applyComplexDatepicker(newInput);

        $newBlock.slideDown(200);
    }

    /**
     * This is the main function called from Form_Refactored.html
     */
    function initializeDatepicker() {
        applyComplexDatepicker('#day1-date');
    }
</script>