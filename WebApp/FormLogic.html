<script>
    /**
     * Form interaction logic
     * Handles form submission, validation, and UI updates
     */
    function initializeFormLogic() {
        // Toggle submit button based on form completion selection
        const toggleSubmitButton = () => {
            const selectedAction = $('input[name="formCompletion"]:checked').val();
            const isContinuing = selectedAction === 'continue';
            const isSelected = selectedAction !== undefined;
            const $submitButton = $('#submit-button');
            const $daySelectionContainer = $('#day-selection-container');

            if (isContinuing) {
                $daySelectionContainer.slideDown(200);
            } else {
                // Hides the datepicker widget if open
                $('#day1-date').datepicker('hide');
                $daySelectionContainer.slideUp(200);
            }

            if (isSelected) {
                $submitButton.prop('disabled', false)
                    .removeClass('bg-gray-400 cursor-not-allowed')
                    .addClass('bg-blue-600 hover:bg-blue-700');
            } else {
                $submitButton.prop('disabled', true)
                    .removeClass('bg-blue-600 hover:bg-blue-700')
                    .addClass('bg-gray-400 cursor-not-allowed');
            }
        };

        // Attach event listener to radio buttons
        $('input[name="formCompletion"]').on('change', toggleSubmitButton);

        // Handle form submission
        $('#request-form').on('submit', function (event) {
            event.preventDefault();

            const selectedAction = $('input[name="formCompletion"]:checked').val();

            if (!selectedAction) {
                console.error("Form submitted without acknowledgment selection.");
                return;
            }

            const formSubmissionData = {
                acknowledgment: selectedAction,
                submittedAt: new Date().toISOString()
            };

            if (selectedAction === 'continue') {

                // Initialize an empty array to hold all selections
                const allDaySelections = [];

                // Loop through all date inputs that are not empty
                // Selector 'input[id$="-date"]' finds all inputs whose ID ends with '-date' (e.g., day1-date, day2-date)
                $('input[id$="-date"]').each(function (index) {
                    const $dateInput = $(this);
                    const dateText = $dateInput.val();

                    // Only process days where a date has been selected
                    if (dateText) {
                        // Extract the numerical day index (e.g., 1 from 'day1-date')
                        const dayIdMatch = this.id.match(/^day(\d+)-date$/);
                        if (!dayIdMatch) return;
                        const dayIndex = parseInt(dayIdMatch[1]);

                        // --- 1. Calculate assigned shift ---
                        let assignedShift = '';
                        try {
                            const dateParts = dateText.split('/');
                            // Months in Date object are 0-indexed (Jan=0), so dateParts[0] - 1 is correct.
                            const dateForCalc = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                            // Assumes getShiftAndBlock is available from ShiftLogic
                            assignedShift = getShiftAndBlock(dateForCalc).shift;
                        } catch (e) {
                            console.error(`Error calculating shift for day ${dayIndex}:`, dateText, e);
                        }

                        // --- 2. Get shift checkboxes for this specific day ---
                        const selectedShifts = [];
                        // Targets input names like 'day1Shift', 'day2Shift', etc.
                        $(`input[name="day${dayIndex}Shift"]:checked`).each(function () {
                            selectedShifts.push($(this).val());
                        });

                        // --- 3. Add to the collection ---
                        allDaySelections.push({
                            day: dayIndex,
                            date: dateText,
                            shifts: selectedShifts,
                            assignedShift: assignedShift
                        });
                    }
                });

                // Assign the collected data to the payload
                formSubmissionData.daySelections = allDaySelections;
            }

            // Display the JSON in the modal
            $('#modal-content').text(JSON.stringify(formSubmissionData, null, 2));

            // Show the modal
            $('#alert-modal').show();
        });

        // Handle closing the modal
        $('#close-modal').on('click', function () {
            $('#alert-modal').hide();
        });
    }
</script>