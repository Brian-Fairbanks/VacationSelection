<script>
    /**
     * Form interaction logic
     * Handles form submission, validation, and UI updates
     */
    function initializeFormLogic() {
        // Toggle submit button based on form completion selection
        const toggleSubmitButton = () => {
            const selectedAction = $('input[name="formCompletion"]:checked').val();
            const isContinuing = selectedAction === 'continue';
            const isSelected = selectedAction !== undefined;
            const $submitButton = $('#submit-button');
            const $daySelectionContainer = $('#day-selection-container');

            if (isContinuing) {
                $daySelectionContainer.slideDown(200);
            } else {
                // Hides the datepicker widget if open
                $('#day1-date').datepicker('hide');
                $daySelectionContainer.slideUp(200);
            }

            if (isSelected) {
                $submitButton.prop('disabled', false)
                    .removeClass('bg-gray-400 cursor-not-allowed')
                    .addClass('bg-blue-600 hover:bg-blue-700');
            } else {
                $submitButton.prop('disabled', true)
                    .removeClass('bg-blue-600 hover:bg-blue-700')
                    .addClass('bg-gray-400 cursor-not-allowed');
            }
        };

        // Attach event listener to radio buttons
        $('input[name="formCompletion"]').on('change', toggleSubmitButton);

        // Handle form submission
        $('#request-form').on('submit', function (event) {
            event.preventDefault();

            const selectedAction = $('input[name="formCompletion"]:checked').val();

            if (!selectedAction) {
                console.error("Form submitted without acknowledgment selection.");
                return;
            }

            const userData = window.USER_INFO || {};
            const submissionDateISO = new Date().toISOString();

            // --- Form Submission Data Object ---
            let formSubmissionData = {
                // Basic Submission Info
                acknowledgment: selectedAction,
                submittedAt: submissionDateISO,

                // --- INTEGRATE USER DATA ---
                userInfo: {
                    // Note: This split/trim logic relies on the server providing "LastName, FirstName"
                    firstName: userData.employeeName ? userData.employeeName.split(',')[1].trim() : '',
                    lastName: userData.employeeName ? userData.employeeName.split(',')[0].trim() : '',
                    employeeId: userData.employeeId || '',
                    rank: userData.rank || '',
                    shift: userData.shift || '',
                    hireDate: userData.hireDate || '',
                    yearsOfService: userData.yearsOfService || '',
                    vacationHours: userData.vacationHours || '',
                    holidayHours: userData.holidayHours || ''
                },
                // daySelections will be added next if 'continue' is selected
            }; 
            // ------------------------------------

            if (selectedAction === 'continue') {
                
                // Initialize an empty array to hold all selections
                const allDaySelections = [];

                // Loop through all date inputs that are not empty
                // Selector 'input[id$="-date"]' finds all inputs whose ID ends with '-date' (e.g., day1-date, day2-date)
                $('input[id$="-date"]').each(function (index) {
                    const $dateInput = $(this);
                    const dateText = $dateInput.val();
                    
                    // Only process days where a date has been selected
                    if (dateText) {
                        // Extract the numerical day index (e.g., 1 from 'day1-date')
                        const dayIdMatch = this.id.match(/^day(\d+)-date$/);
                        if (!dayIdMatch) return;
                        const dayIndex = parseInt(dayIdMatch[1]);
                        
                        const selectedShifts = [];
                        // Targets input names like 'day1Shift', 'day2Shift', etc.
                        $(`input[name="day${dayIndex}Shift"]:checked`).each(function () {
                            selectedShifts.push($(this).val());
                        });

                        // Add to the collection
                        allDaySelections.push({
                            day: dayIndex,
                            date: dateText,
                            shifts: selectedShifts,
                        });
                    }
                });

                // Assign the collected data to the payload
                formSubmissionData.daySelections = allDaySelections;
            }
            
            // --- SERVER CALL ---
            google.script.run
                .withSuccessHandler(function() {
                    alert("Submission successful!");
                    $('#alert-modal').hide();
                })
                .withFailureHandler(function(err) {
                    alert("Error submitting form: " + err.message);
                    $('#alert-modal').hide();
                })
                .processShiftRequest(formSubmissionData); 
            // -------------------

            // Display the JSON in the modal (for debugging only)
            $('#modal-content').text(JSON.stringify(formSubmissionData, null, 2));

            // Show the modal
            $('#alert-modal').show();
        });

        // Handle closing the modal
        $('#close-modal').on('click', function () {
            $('#alert-modal').hide();
        });
    }
</script>