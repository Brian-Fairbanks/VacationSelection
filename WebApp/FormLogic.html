<script>
    /**
     * Form interaction logic
     * Handles form submission, validation, and UI updates
     */
    function initializeFormLogic() {
        // Toggle submit button based on form completion selection
        const toggleSubmitButton = () => {
            const selectedAction = $('input[name="formCompletion"]:checked').val();
            const isContinuing = selectedAction === 'continue';
            const isSelected = selectedAction !== undefined;
            const $submitButton = $('#submit-button');
            const $daySelectionContainer = $('#day-selection-container');

            if (isContinuing) {
                $daySelectionContainer.slideDown(200);
            } else {
                // Hides the datepicker widget if open
                $('#day1-date').datepicker('hide');
                $daySelectionContainer.slideUp(200);
            }

            if (isSelected) {
                $submitButton.prop('disabled', false)
                    .removeClass('bg-gray-400 cursor-not-allowed')
                    .addClass('bg-blue-600 hover:bg-blue-700');
            } else {
                $submitButton.prop('disabled', true)
                    .removeClass('bg-blue-600 hover:bg-blue-700')
                    .addClass('bg-gray-400 cursor-not-allowed');
            }
        };

        // Prevent the Enter key (keyCode 13) from submitting the form.
        $('#request-form').on('keypress', 'input, select', function (e) {
            if (e.keyCode === 13) {
                e.preventDefault();
            }
        });

        // Attach event listener to radio buttons
        $('#day-selection-container').on(
            'change',
            'input[type="checkbox"][name^="day"][name$="Shift"]',
            function () {
                // ... (existing checkbox logic remains unchanged) ...
                const name = $(this).attr('name'); // e.g. "day3Shift"
                const m = name.match(/^day(\d+)Shift$/);
                if (!m) return;

                const dayNum = parseInt(m[1], 10);
                const $checkboxes = $(`input[name="day${dayNum}Shift"]`);
                const anyChecked = $checkboxes.is(':checked');
                const $dateInput = $(`#day${dayNum}-date`);

                // Only react when we just went to 0 halves on a day that had a date
                if (!anyChecked) {
                    // 1) Clear the date (no request for that block anymore)
                    $dateInput.val('');

                    // 2) Clear global state + feedback, but do NOT re-disable boxes
                    enforceCheckboxState($dateInput, dayNum);

                    // 3) Put the row back into "default ready" state:
                    $checkboxes.prop('disabled', false).prop('checked', true);

                    // 4) Make sure row management runs
                    clearTimeout(window.emptyRowTimeout);
                    window.emptyRowTimeout = setTimeout(manageEmptyRows, 50);
                }
            }
        );

        $('input[name="formCompletion"]').on('change', toggleSubmitButton);

        // Handle form submission
        $('#request-form').on('submit', function (event) {
            event.preventDefault();

            const selectedAction = $('input[name="formCompletion"]:checked').val();
            if (!selectedAction) {
                console.error("Form submitted without acknowledgment selection.");
                return;
            }

            // ðŸš« Block submission if any invalid dates (unchanged)
            let hasInvalid = false;
            $('.datepicker').each(function () {
                if ($(this).data('invalid')) {
                    hasInvalid = true;
                    $(this).addClass('border-red-500'); // reinforce visually
                }
            });

            if (hasInvalid) {
                showAppModal(
                    "Fix Dates",
                    "<p>One or more dates are invalid. Please correct the red fields before submitting.</p>",
                    '<button type="button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700" id="btn-fix-dates">OK</button>'
                );
                $('#btn-fix-dates').one('click', hideAppModal);
                return; // stop submission
            }

            // --- Determine User Data Source (UPDATED) ---
            // Check if window.USER_INFO was set by the manual entry modal
            const isManual = window.USER_INFO && (window.USER_INFO.manualEntry === true || window.USER_INFO.trackingLevel==="Manual Entry");
            const userData = isManual ? window.USER_INFO : window.USER_INFO || {};

            const submissionDateISO = new Date().toISOString();

            // --- Form Submission Data Object (UPDATED) ---
            let formSubmissionData = {
                acknowledgment: selectedAction,
                isManualEntry: isManual, // ðŸ”¥ New flag for the server
                submittedAt: submissionDateISO,
                userInfo: {
                    // Use data directly if manual, otherwise use split/defaults
                    firstName: userData.firstName || (userData.employeeName ? userData.employeeName.split(',')[1].trim() : ''),
                    lastName: userData.lastName || (userData.employeeName ? userData.employeeName.split(',')[0].trim() : ''),
                    employeeId: userData.employeeId || '',
                    rank: userData.rank || '',
                    shift: userData.shift || '',
                    // Other fields that might be missing in manual entry can be kept empty
                    hireDate: userData.hireDate || '',
                    yearsOfService: userData.yearsOfService || '',
                    vacationHours: userData.vacationHours || '',
                    holidayHours: userData.holidayHours || ''
                },
            };

            // --- Add day selections (if any) ---
            if (selectedAction === 'continue') {
                const allDaySelections = [];
                $('input[id$="-date"]').each(function () {
                    const $dateInput = $(this);
                    const dateText = $dateInput.val();

                    if (dateText) {
                        const dayIdMatch = this.id.match(/^day(\d+)-date$/);
                        if (!dayIdMatch) return;
                        const dayIndex = parseInt(dayIdMatch[1]);

                        // Get Shifts
                        const selectedShifts = [];
                        $(`input[name="day${dayIndex}Shift"]:checked`).each(function () {
                            selectedShifts.push($(this).val());
                        });

                        // --- NEW: Get Prioritize Checkbox Status ---
                        const isPrioritized = $(`#day${dayIndex}-prioritize`).is(':checked');
                        // ------------------------------------------

                        allDaySelections.push({
                            day: dayIndex,
                            date: dateText,
                            shifts: selectedShifts,
                            prioritize: isPrioritized // <--- Add to payload
                        });
                    }
                });
                formSubmissionData.daySelections = allDaySelections;
            }


            // --- 1. Show "Submitting..." MODAL FIRST ---
            var loadingContent = `
                <div class="flex flex-col items-center justify-center h-24">
                    <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-600">Submitting your selections...</p>
                </div>
            `;
            showAppModal("Submitting...", loadingContent, "");
            console.log(formSubmissionData)

            // --- 2. SERVER CALL ---
            google.script.run
                .withSuccessHandler(function () {
                    var title = "Submission Successful";
                    var content = "<p>Your vacation picks have been recorded.</p>";
                    var button = '<button id="btn-submit-ok" type="button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">OK</button>';

                    showAppModal(title, content, button);

                    $('#btn-submit-ok').one('click', function () {
                        hideAppModal();
                    });
                })
                .withFailureHandler(function (err) {
                    var title = "Submission Error";
                    var content = `<p>An error occurred. Your submission was not saved.</p>
                                <p class="mt-2 text-xs text-red-500"><strong>Error:</strong> ${err.message}</p>
                                <p class="mt-4 text-xs text-gray-500">Your data (for debugging):</p>
                                <pre class="mt-2 bg-gray-100 p-2 text-xs rounded">${JSON.stringify(formSubmissionData, null, 2)}</pre>`;
                    var button = '<button id="btn-submit-fail" type="button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Close</button>';

                    showAppModal(title, content, button);

                    $('#btn-submit-fail').one('click', function () {
                        hideAppModal();
                    });
                })
                .processShiftRequest(formSubmissionData);
        });

        // Handle closing the modal
        $('#close-modal').on('click', function () {
            hideAppModal();
        });
    }
</script>


